datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  output        = "../backend/node_modules/.prisma/client"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

model User {
  id             String         @id @default(cuid())
  name           String
  email          String         @unique
  passwordHash   String
  role           String         @default("AGENT")
  conversations  Conversation[] @relation("UserConversations")
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model Contact {
  id            String          @id @default(cuid())
  waId          String?         @unique
  phone         String?
  name          String?
  displayName   String?
  candidateName String?
  candidateNameManual String?
  noContact     Boolean         @default(false)
  noContactAt   DateTime?
  noContactReason String?
  notes         String?
  conversations Conversation[]
  interviewReservations InterviewReservation[]
  sellerEvents  SellerEvent[]
  applications  Application[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model Conversation {
  id            String             @id @default(cuid())
  contact       Contact            @relation(fields: [contactId], references: [id])
  contactId     String
  status        String             @default("NEW")
  assignedTo    User?              @relation("UserConversations", fields: [assignedToId], references: [id])
  assignedToId  String?
  channel       String
  isAdmin       Boolean            @default(false)
  aiMode        String             @default("RECRUIT")
  aiPaused      Boolean            @default(false)
  interviewDay  String?
  interviewTime String?
  interviewLocation String?
  interviewStatus String?
  interviewReservations InterviewReservation[]
  sellerEvents  SellerEvent[]
  adminLastCandidateWaId String?
  adminPendingAction    String?
  messages      Message[]
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
}

model Message {
  id             String        @id @default(cuid())
  conversation   Conversation  @relation(fields: [conversationId], references: [id])
  conversationId String
  direction      String
  text           String
  rawPayload     String?
  mediaType      String?
  mediaMime      String?
  mediaPath      String?
  transcriptText String?
  timestamp      DateTime
  read           Boolean       @default(false)
  createdAt      DateTime      @default(now())
}

model Campaign {
  id          String             @id @default(cuid())
  name        String
  slug        String             @unique
  description String?
  city        String?
  country     String?
  status      String             @default("ACTIVE")
  profileJson String?
  schema      ApplicationSchema?
  applications Application[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

model ApplicationSchema {
  id          String   @id @default(cuid())
  campaign    Campaign @relation(fields: [campaignId], references: [id])
  campaignId  String   @unique
  schema      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Application {
  id           String            @id @default(cuid())
  contact      Contact           @relation(fields: [contactId], references: [id])
  contactId    String
  campaign     Campaign?         @relation(fields: [campaignId], references: [id])
  campaignId   String?
  status       String            @default("DRAFT")
  data         String
  source       String
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

model SystemConfig {
  id              Int      @id @default(1)
  whatsappBaseUrl String?
  whatsappToken   String?
  whatsappPhoneId String?
  whatsappVerifyToken String?
  botAutoReply    Boolean  @default(true)
  openAiApiKey    String?
  aiPrompt        String?
  aiModel         String?
  adminEmail      String?
  adminWaId       String?
  adminAiPrompt   String?
  adminAiModel    String?
  adminAiAddendum String?
  interviewAiPrompt String?
  interviewAiModel  String?
  templateInterviewInvite String?
  templateGeneralFollowup String?
  templateLanguageCode String?
  defaultJobTitle String?
  defaultInterviewDay String?
  defaultInterviewTime String?
  defaultInterviewLocation String?
  interviewTimezone String?
  interviewSlotMinutes Int?
  interviewWeeklyAvailability String?
  interviewExceptions String?
  interviewLocations String?
  testPhoneNumber String?
  salesAiPrompt    String?
  salesKnowledgeBase String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model InterviewReservation {
  id             String        @id @default(cuid())
  conversation   Conversation  @relation(fields: [conversationId], references: [id])
  conversationId String
  contact        Contact       @relation(fields: [contactId], references: [id])
  contactId      String
  startAt        DateTime
  endAt          DateTime
  timezone       String
  location       String
  activeKey      String?       @default("ACTIVE")
  status         String        @default("PENDING")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([conversationId])
  @@index([contactId])
  @@index([startAt])
  @@unique([startAt, location, activeKey])
}

model InterviewSlotBlock {
  id        String   @id @default(cuid())
  startAt   DateTime
  endAt     DateTime
  timezone  String
  location  String
  reason    String?
  tag       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([startAt])
  @@index([tag])
  @@unique([startAt, location])
}

model SellerEvent {
  id             String        @id @default(cuid())
  conversation   Conversation  @relation(fields: [conversationId], references: [id])
  conversationId String
  contact        Contact       @relation(fields: [contactId], references: [id])
  contactId      String
  type           String
  occurredAt     DateTime
  rawText        String
  dataJson       String?
  createdAt      DateTime      @default(now())

  @@index([conversationId])
  @@index([contactId])
  @@index([occurredAt])
  @@index([type])
}

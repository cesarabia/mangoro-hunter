datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  output        = "../backend/node_modules/.prisma/client"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

model User {
  id             String         @id @default(cuid())
  name           String
  email          String         @unique
  passwordHash   String
  role           String         @default("AGENT")
  memberships    Membership[]
  conversations  Conversation[] @relation("UserConversations")
  copilotRuns    CopilotRunLog[]
  copilotThreads CopilotThread[]
  scenarioRuns   ScenarioRunLog[]
  configChanges  ConfigChangeLog[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model Workspace {
  id          String        @id @default(cuid())
  name        String
  isSandbox   Boolean       @default(false)
  memberships Membership[]
  phoneLines  PhoneLine[]
  programs    Program[]
  automations AutomationRule[]
  automationRuns AutomationRunLog[]
  conversations Conversation[]
  contacts    Contact[]
  agentRuns   AgentRunLog[]
  outboundLogs OutboundMessageLog[]
  copilotRuns CopilotRunLog[]
  copilotThreads CopilotThread[]
  aiUsageLogs AiUsageLog[]
  scenarioRuns ScenarioRunLog[]
  configChanges ConfigChangeLog[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model ConfigChangeLog {
  id          String    @id @default(cuid())
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId String    @default("default")
  user        User?     @relation(fields: [userId], references: [id])
  userId      String?
  type        String
  beforeJson  String?
  afterJson   String?
  createdAt   DateTime  @default(now())

  @@index([workspaceId])
  @@index([createdAt])
}

model Membership {
  id          String    @id @default(cuid())
  user        User      @relation(fields: [userId], references: [id])
  userId      String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId String
  role        String
  archivedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, workspaceId])
  @@index([workspaceId])
}

model PhoneLine {
  id              String    @id @default(cuid())
  workspace       Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId     String
  alias           String
  phoneE164       String?
  waPhoneNumberId String
  wabaId          String?
  defaultProgram  Program?  @relation("PhoneLineDefaultProgram", fields: [defaultProgramId], references: [id])
  defaultProgramId String?
  isActive        Boolean   @default(true)
  lastInboundAt   DateTime?
  lastOutboundAt  DateTime?
  archivedAt      DateTime?
  conversations   Conversation[]
  scopedAutomations AutomationRule[]
  agentRuns        AgentRunLog[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([workspaceId])
  @@unique([workspaceId, waPhoneNumberId])
  @@unique([workspaceId, phoneE164])
}

model Program {
  id              String    @id @default(cuid())
  workspace       Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId     String
  name            String
  slug            String
  description     String?
  isActive        Boolean   @default(true)
  agentSystemPrompt String
  archivedAt      DateTime?
  conversations   Conversation[]
  defaultInLines  PhoneLine[] @relation("PhoneLineDefaultProgram")
  automations     AutomationRule[]
  agentRuns       AgentRunLog[]
  aiUsageLogs     AiUsageLog[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([workspaceId, slug])
  @@index([workspaceId])
}

model Contact {
  id            String          @id @default(cuid())
  workspace     Workspace       @relation(fields: [workspaceId], references: [id])
  workspaceId   String          @default("default")
  waId          String?
  phone         String?
  name          String?
  displayName   String?
  candidateName String?
  candidateNameManual String?
  email         String?
  rut           String?
  comuna        String?
  ciudad        String?
  region        String?
  experienceYears Int?
  terrainExperience Boolean?
  availabilityText String?
  noContact     Boolean         @default(false)
  noContactAt   DateTime?
  noContactReason String?
  notes         String?
  mergedIntoContactId String?
  mergedAt      DateTime?
  mergedReason  String?
  archivedAt    DateTime?
  conversations Conversation[]
  interviewReservations InterviewReservation[]
  sellerEvents  SellerEvent[]
  applications  Application[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([workspaceId])
  @@unique([workspaceId, waId])
  @@unique([workspaceId, phone])
}

model Conversation {
  id            String             @id @default(cuid())
  workspace     Workspace          @relation(fields: [workspaceId], references: [id])
  workspaceId   String             @default("default")
  phoneLine     PhoneLine          @relation(fields: [phoneLineId], references: [id])
  phoneLineId   String             @default("default")
  program       Program?           @relation(fields: [programId], references: [id])
  programId     String?
  contact       Contact            @relation(fields: [contactId], references: [id])
  contactId     String
  status        String             @default("NEW")
  conversationStage String         @default("NEW_INTAKE")
  stageReason   String?
  stageTags     String?
  archivedAt    DateTime?
  archivedSummary String?
  sandboxSourceConversationId String?
  assignedTo    User?              @relation("UserConversations", fields: [assignedToId], references: [id])
  assignedToId  String?
  channel       String
  isAdmin       Boolean            @default(false)
  aiMode        String             @default("RECRUIT")
  aiPaused      Boolean            @default(false)
  interviewDay  String?
  interviewTime String?
  interviewLocation String?
  interviewStatus String?
  interviewReservations InterviewReservation[]
  sellerEvents  SellerEvent[]
  adminLastCandidateWaId String?
  adminPendingAction    String?
  messages      Message[]
  askedFields   ConversationAskedField[]
  agentRuns     AgentRunLog[]
  outboundLogs  OutboundMessageLog[]
  copilotRuns   CopilotRunLog[]
  aiUsageLogs   AiUsageLog[]
  scenarioRuns  ScenarioRunLog[]
  automationRuns AutomationRunLog[]
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([workspaceId])
  @@index([phoneLineId])
  @@index([programId])
}

model Message {
  id             String        @id @default(cuid())
  conversation   Conversation  @relation(fields: [conversationId], references: [id])
  conversationId String
  waMessageId    String?       @unique
  direction      String
  text           String
  rawPayload     String?
  mediaType      String?
  mediaMime      String?
  mediaPath      String?
  transcriptText String?
  timestamp      DateTime
  read           Boolean       @default(false)
  createdAt      DateTime      @default(now())
}

model ConversationAskedField {
  id             String       @id @default(cuid())
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId String
  field          String
  askCount       Int          @default(0)
  lastAskedAt    DateTime?
  lastAskedHash  String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([conversationId, field])
  @@index([conversationId])
}

model AgentRunLog {
  id             String       @id @default(cuid())
  workspace      Workspace    @relation(fields: [workspaceId], references: [id])
  workspaceId    String       @default("default")
  conversation   Conversation? @relation(fields: [conversationId], references: [id])
  conversationId String?
  program        Program?     @relation(fields: [programId], references: [id])
  programId      String?
  phoneLine      PhoneLine?   @relation(fields: [phoneLineId], references: [id])
  phoneLineId    String?
  eventType      String
  status         String       @default("SUCCESS")
  inputContextJson String
  commandsJson   String?
  resultsJson    String?
  error          String?
  toolCalls      ToolCallLog[]
  outboundLogs   OutboundMessageLog[]
  aiUsageLogs    AiUsageLog[]
  createdAt      DateTime     @default(now())

  @@index([workspaceId])
  @@index([conversationId])
  @@index([createdAt])
}

model ToolCallLog {
  id          String     @id @default(cuid())
  agentRun    AgentRunLog @relation(fields: [agentRunId], references: [id])
  agentRunId  String
  toolName    String
  argsJson    String
  resultJson  String?
  error       String?
  createdAt   DateTime   @default(now())

  @@index([agentRunId])
}

model OutboundMessageLog {
  id            String       @id @default(cuid())
  workspace     Workspace    @relation(fields: [workspaceId], references: [id])
  workspaceId   String       @default("default")
  conversation  Conversation @relation(fields: [conversationId], references: [id])
  conversationId String
  agentRun      AgentRunLog? @relation(fields: [agentRunId], references: [id])
  agentRunId    String?
  channel       String
  type          String
  templateName  String?
  dedupeKey     String
  textHash      String
  blockedReason String?
  waMessageId   String?
  createdAt     DateTime     @default(now())

  @@index([conversationId])
  @@index([workspaceId])
  @@index([createdAt])
  @@index([dedupeKey])
}

model CopilotThread {
  id          String     @id @default(cuid())
  workspace   Workspace  @relation(fields: [workspaceId], references: [id])
  workspaceId String     @default("default")
  user        User?      @relation(fields: [userId], references: [id])
  userId      String?
  title       String?
  archivedAt  DateTime?
  runs        CopilotRunLog[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([workspaceId])
  @@index([userId])
  @@index([createdAt])
}

model CopilotRunLog {
  id            String     @id @default(cuid())
  workspace     Workspace  @relation(fields: [workspaceId], references: [id])
  workspaceId   String     @default("default")
  user          User?      @relation(fields: [userId], references: [id])
  userId        String?
  thread        CopilotThread? @relation(fields: [threadId], references: [id])
  threadId      String?
  conversation  Conversation? @relation(fields: [conversationId], references: [id])
  conversationId String?
  view          String?
  inputText     String
  responseText  String?
  actionsJson   String?
  proposalsJson String?
  resultsJson   String?
  status        String     @default("SUCCESS")
  error         String?
  confirmedAt   DateTime?
  confirmedByUserId String?
  aiUsage       AiUsageLog[]
  createdAt     DateTime   @default(now())

  @@index([workspaceId])
  @@index([threadId])
  @@index([conversationId])
  @@index([createdAt])
}

model AiUsageLog {
  id            String     @id @default(cuid())
  workspace     Workspace  @relation(fields: [workspaceId], references: [id])
  workspaceId   String     @default("default")
  actor         String
  model         String
  inputTokens   Int        @default(0)
  outputTokens  Int        @default(0)
  totalTokens   Int        @default(0)
  agentRun      AgentRunLog? @relation(fields: [agentRunId], references: [id])
  agentRunId    String?
  copilotRun    CopilotRunLog? @relation(fields: [copilotRunId], references: [id])
  copilotRunId  String?
  conversation  Conversation? @relation(fields: [conversationId], references: [id])
  conversationId String?
  program       Program?   @relation(fields: [programId], references: [id])
  programId     String?
  createdAt     DateTime   @default(now())

  @@index([workspaceId])
  @@index([createdAt])
  @@index([programId])
  @@index([conversationId])
  @@index([actor])
  @@index([model])
}

model ScenarioRunLog {
  id                    String     @id @default(cuid())
  workspace             Workspace  @relation(fields: [workspaceId], references: [id])
  workspaceId           String     @default("sandbox")
  scenarioId            String
  ok                    Boolean    @default(false)
  sessionConversation    Conversation? @relation(fields: [sessionConversationId], references: [id])
  sessionConversationId String?
  triggeredBy           User?      @relation(fields: [triggeredByUserId], references: [id])
  triggeredByUserId     String?
  startedAt             DateTime
  finishedAt            DateTime
  createdAt             DateTime   @default(now())

  @@index([workspaceId])
  @@index([scenarioId])
  @@index([createdAt])
}

model AutomationRule {
  id              String    @id @default(cuid())
  workspace       Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId     String     @default("default")
  name            String
  enabled         Boolean    @default(true)
  priority        Int        @default(100)
  trigger         String
  scopePhoneLine  PhoneLine? @relation(fields: [scopePhoneLineId], references: [id])
  scopePhoneLineId String?
  scopeProgram    Program?   @relation(fields: [scopeProgramId], references: [id])
  scopeProgramId  String?
  conditionsJson  String
  actionsJson     String
  archivedAt      DateTime?
  runs            AutomationRunLog[]
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([workspaceId])
  @@index([trigger])
  @@index([priority])
}

model AutomationRunLog {
  id             String        @id @default(cuid())
  workspace      Workspace     @relation(fields: [workspaceId], references: [id])
  workspaceId    String        @default("default")
  rule           AutomationRule? @relation(fields: [ruleId], references: [id])
  ruleId         String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id])
  conversationId String?
  eventType      String
  status         String
  inputJson      String?
  outputJson     String?
  error          String?
  createdAt      DateTime      @default(now())

  @@index([workspaceId])
  @@index([ruleId])
  @@index([createdAt])
}

model Campaign {
  id          String             @id @default(cuid())
  name        String
  slug        String             @unique
  description String?
  city        String?
  country     String?
  status      String             @default("ACTIVE")
  profileJson String?
  schema      ApplicationSchema?
  applications Application[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

model ApplicationSchema {
  id          String   @id @default(cuid())
  campaign    Campaign @relation(fields: [campaignId], references: [id])
  campaignId  String   @unique
  schema      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Application {
  id           String            @id @default(cuid())
  contact      Contact           @relation(fields: [contactId], references: [id])
  contactId    String
  campaign     Campaign?         @relation(fields: [campaignId], references: [id])
  campaignId   String?
  status       String            @default("DRAFT")
  data         String
  source       String
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

model SystemConfig {
  id              Int      @id @default(1)
  whatsappBaseUrl String?
  whatsappToken   String?
  whatsappPhoneId String?
  whatsappVerifyToken String?
  botAutoReply    Boolean  @default(true)
  outboundPolicy String?
  outboundAllowlist String?
  outboundAllowAllUntil DateTime?
  devReleaseNotes String?
  openAiModelPricing String?
  whatsappPricing    String?
  openAiApiKey    String?
  aiPrompt        String?
  aiModel         String?
  recruitJobSheet String?
  recruitFaq      String?
  adminEmail      String?
  adminWaId       String?
  adminWaIds      String?
  adminAiPrompt   String?
  adminAiModel    String?
  adminAiAddendum String?
  interviewAiPrompt String?
  interviewAiModel  String?
  templateInterviewInvite String?
  templateGeneralFollowup String?
  templateLanguageCode String?
  defaultJobTitle String?
  defaultInterviewDay String?
  defaultInterviewTime String?
  defaultInterviewLocation String?
  interviewTimezone String?
  interviewSlotMinutes Int?
  interviewWeeklyAvailability String?
  interviewExceptions String?
  interviewLocations String?
  testPhoneNumber String?
  testPhoneNumbers String?
  salesAiPrompt    String?
  salesKnowledgeBase String?
  adminNotificationDetailLevel String?
  adminNotificationTemplates String?
  adminNotificationEnabledEvents String?
  adminNotificationDetailLevelsByEvent String?
  workflowRules  String?
  workflowInactivityDays Int?
  workflowArchiveDays Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model InterviewReservation {
  id             String        @id @default(cuid())
  conversation   Conversation  @relation(fields: [conversationId], references: [id])
  conversationId String
  contact        Contact       @relation(fields: [contactId], references: [id])
  contactId      String
  startAt        DateTime
  endAt          DateTime
  timezone       String
  location       String
  activeKey      String?       @default("ACTIVE")
  status         String        @default("PENDING")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([conversationId])
  @@index([contactId])
  @@index([startAt])
  @@unique([startAt, location, activeKey])
}

model InterviewSlotBlock {
  id        String   @id @default(cuid())
  startAt   DateTime
  endAt     DateTime
  timezone  String
  location  String
  reason    String?
  tag       String?
  archivedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([startAt])
  @@index([tag])
  @@unique([startAt, location])
}

model SellerEvent {
  id             String        @id @default(cuid())
  conversation   Conversation  @relation(fields: [conversationId], references: [id])
  conversationId String
  contact        Contact       @relation(fields: [contactId], references: [id])
  contactId      String
  type           String
  occurredAt     DateTime
  rawText        String
  dataJson       String?
  createdAt      DateTime      @default(now())

  @@index([conversationId])
  @@index([contactId])
  @@index([occurredAt])
  @@index([type])
}
